---
title: Spring Testing
permalink: /pages/spring/testing/
article: true
date: 2022-05-26 23:00:25
---

# 测试

> 5.3.2

本章介绍了Spring对集成测试的支持和单元测试的最佳实践。Spring团队倡导测试驱动的开发（TDD）。Spring团队发现，正确使用控制反转（IOC）确实使单元和集成测试更加容易（因为存在setter 方法和类上适当的构造函数，因此无需设置服务定位器注册表和类似结构就能很容的把它们联系在一起）。

# 1. 介绍Spring Testing

测试是企业软件开发的组成部分。本章重点介绍了IOC原理为单元测试增添的价值以及Spring 框架对集成测试支持的好处。（企业中对测试的=处理超出了本参考手册的范围。）

# 2. 单元测试

依赖注入应降低代码对容器的依赖，而不是像传统的Java EE开发那样。构成您应用程序的POJOs应该在JUnit 或TestNG 测试中可进行测试，并通过使用new操作符，不需要使用Spring或任何其他容器来实例化对象。您可以使用 [mock objects](https://docs.spring.io/spring-framework/docs/5.3.2/reference/html/testing.html#mock-objects)（与其他有价值的测试技术结合使用）来隔离测试代码。如果您遵循有关Spring的体系结构建议，则代码库的清洁分层和组件促进了更容易的单元测试。例如，您可以通过stub或mock DAO或仓储层接口来测试服务层对象，而无需在运行单元测试时访问持久数据。

真正的单元测试通常非常快地运行，因为没有运行时基础架构可以设置。真正的单位测试作为开发方法的一部分可以提高您的生产效率。您可能不需要测试章节的这一部分来帮助您为基于IOC的应用程序编写有效的单元测试。但是，对于某些单元测试方案，Spring框架提供了mock对象和测试支持类，这将在本章中进行描述。

## 2.1. Mock对象

Spring包括许多专门用于mock的软件包：

- [Environment](https://docs.spring.io/spring-framework/docs/5.3.2/reference/html/testing.html#mock-objects-env)
- [JNDI](https://docs.spring.io/spring-framework/docs/5.3.2/reference/html/testing.html#mock-objects-jndi)
- [Servlet API](https://docs.spring.io/spring-framework/docs/5.3.2/reference/html/testing.html#mock-objects-servlet)
- [Spring Web Reactive](https://docs.spring.io/spring-framework/docs/5.3.2/reference/html/testing.html#mock-objects-web-reactive)

### 2.1.1. Environment

`org.springframework.mock.env`软件包包含`Environment`和`PropertySource`抽象的模拟实现（请参阅[Bean Definition Profiles](https://docs.spring.io/spring-framework/docs/5.3.2/reference/html/core.html#beans-definition-profiles)和[`PropertySource` Abstraction](https://docs.spring.io/spring-framework/docs/5.3.2/reference/html/core.html#beans-property-source-abstraction)）。`MockEnvironment`和模拟`MockPropertySource`对于开发容器外的依赖于特定环境属性代码的测试很有用。



### 2.1.2. JNDI

`org.springframework.mock.jndi`软件包包含JNDI SPI的部分实现，您可以使用它来为测试套件或独立应用程序设置简单的JNDI环境。例如，如果JDBC `DataSource`实例与Java EE容器中的测试代码绑定到相同的JNDI名称，则可以在未经修改的情况下重复使用应用程序代码和配置。

·:warning:`org.springframework.mock.jndi`软件包中的模拟JNDI支持正式在Spring 5.2正式弃用，因为其已支持[Simple-JNDI](https://github.com/h-thurow/Simple-JNDI)等第三方的完整解决方案。

### 2.1.3. Servlet API

`org.springframework.mock.web`软件包包含一组全面的Servlet API模拟对象，这些对象可用于测试Web上下文，控制器和过滤器。这些模拟对象针对的是使用Spring Web MVC框架的应用，且通常比动态模拟对象（例如[EasyMock](http://easymock.org/)）或可替代的Servlet API模拟对象（例如[MockObjects](http://www.mockobjects.com/)）更方便使用。

> :bulb:从Spring 5.0起，`org.springframework.mock.web`中的模拟对象基于Servlet 4.0 API。

Spring MVC测试框架在模拟Servlet  API对象上构建，为Spring MVC提供集成测试框架。请参阅[MockMvc](https://docs.spring.io/spring-framework/docs/5.3.2/reference/html/testing.html#spring-mvc-test-framework)。

### 2.1.4. Spring Web Reactive

`org.springframework.mock.http.server.reactive`软件包包含`ServerHttpRequest`和`ServerHttpRequest`的模拟实现，可用于WebFlux应用程序。`org.springframework.mock.web.server`软件包包含一个取决于模拟请求和响应对象的模拟`ServerWebExchange`。

`MockServerHttpRequest`和`MockServerHttpResponse`都继承服务器特定实现的抽象基类，并与他们共享行为。例如，一旦创建了一个不可变的模拟请求，但是您可以使用`ServerHttpRequest`的`mutate()`方法来创建可修改的实例。

为了使模拟响应正确实现写入归约并返回写入完成句柄（即`Mono<Void>`），默认情况下，它使用Flux的cache().then()，缓冲数据并使其在测试中可用于断言。应用程序可以设置自定义写入功能（例如，测试无限流）。

[WebTestClient](https://docs.spring.io/spring-framework/docs/5.3.2/reference/html/testing.html#webtestclient)在模拟请求和响应上构建，以提供没有HTTP服务器的WebFlux应用程序的支持。客户也可以使用运行服务器用于端到端测试。

## 2.2. 单元测试支持类

Spring包括许多可以帮助单元测试的类。他们分为两类：

- [一般测试工具类](https://docs.spring.io/spring-framework/docs/5.3.2/reference/html/testing.html#unit-testing-utilities)
- [Spring MVC测试工具类](https://docs.spring.io/spring-framework/docs/5.3.2/reference/html/testing.html#unit-testing-spring-mvc)

### 2.2.1. 一般测试工具类

`org.springframework.test.util`软件包包含多个通用工具方法，用于单元和集成测试。

`ReflectionTestUtils`是基于反射的工具方法的集合。您可以在测试场景中使用这些方法，在这些场景中，您需要更改常数的值，设置非public字段，调用非public setter方法，或调用非public配置或生命周期回调方法，例如以下内容：

- ORM 框架 (例如JPA和 Hibernate) condone private或protected的字段访问，而不是领域实体中属性的public setter方法。
- Spring对注解的支持（例如`@Autowired`，`@Inject`和`@Resource`），可为private或protected字段，setter方法和配置方法提供依赖注入。
- 使用`@PostConstruct`和`@PreDestroy`等注解用于生命周期回调方法。

[`AopTestUtils`](https://docs.spring.io/spring-framework/docs/5.3.2/javadoc-api/org/springframework/test/util/AopTestUtils.html)是与AOP相关的工具方法的集合。您可以使用这些方法来获取隐藏在一个或多个Spring代理后面的基础目标对象的引用。例如，如果您通过使用EasyMock或Mockito之类的库将bean配置为动态mock，并且该模拟包裹在Spring 代理中，则可能需要直接访问基础模拟以对其进行配置并执行验证。有关Spring的核心AOP工具方法，请参阅[`AopUtils`](https://docs.spring.io/spring-framework/docs/5.3.2/javadoc-api/org/springframework/aop/support/AopUtils.html)和[`AopProxyUtils`](https://docs.spring.io/spring-framework/docs/5.3.2/javadoc-api/org/springframework/aop/framework/AopProxyUtils.html)。

### 2.2.2. Spring MVC 测试工具类

`org.springframework.test.web`软件包包含[`ModelAndViewAssert`](https://docs.spring.io/spring-framework/docs/5.3.2/javadoc-api/org/springframework/test/web/ModelAndViewAssert.html)，您可以将其与JUnit，TestNG或任何其他测试框架结合使用，用于与Spring MVC ModelAndView对象进行的单元测试。

> :bulb:**单元测试Spring MVC Controllers**
>
> 要将Spring MVC Controller类视为POJOs进行单元测试，请将ModelAndViewAssert与Spring的[Servlet API mocks](https://docs.spring.io/spring-framework/docs/5.3.2/reference/html/testing.html#mock-objects-servlet)中的MockHttpServletRequest，MockHttpSession等等结合使用。要用Spring MVC的WebApplicationContext配置结合使用Spring MVC和REST Controller类进行集成测试，请改用 [Spring MVC Test Framework](https://docs.spring.io/spring-framework/docs/5.3.2/reference/html/testing.html#spring-mvc-test-framework)。

# 3. 集成测试









